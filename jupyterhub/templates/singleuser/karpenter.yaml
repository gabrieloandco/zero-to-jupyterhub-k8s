{{- if .Values.singleuser.karpenter.enabled -}}
apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: {{ include "jupyterhub.singleuser.fullname" . }}
  labels: 
    {{- include "jupyterhub.labels" . | nindent 4 }}
    provisioned: karpenter
spec:
  ttlSecondsUntilExpired: 2592000 # 30 Days=60*60*24*30 Seconds;
  ttlSecondsAfterEmpty: 30
  taints: 
    {{- with .Values.singleuser.karpenter.taints}}
    {{- . | toYaml | nindent 4 }}
    {{- end }}
  labels: 
    {{- include "jupyterhub.labels" . | nindent 4 }}
    provisioned: karpenter
  requirements:
    - key: "node.kubernetes.io/instance-type"
      operator: In
      values: {{ .Values.singleuser.karpenter.requirements.instanceTypes | toJson }}
    - key: "topology.kubernetes.io/zone"
      operator: In
      values: {{ .Values.singleuser.karpenter.requirements.zones | toJson }}
    - key: "kubernetes.io/arch"
      operator: In
      values: {{ .Values.singleuser.karpenter.requirements.arch | toJson }}
    - key: "karpenter.sh/capacity-type" 
      operator: In
      values: {{ .Values.singleuser.karpenter.requirements.capacityTypes | toJson }}
  limits:
    resources:
      cpu: {{ .Values.singleuser.karpenter.limits.cpu }}
      memory: {{ .Values.singleuser.karpenter.limits.memory }} 
  provider:
    subnetSelector: 
        {{- with .Values.singleuser.karpenter.provider.subnetSelector }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}
    securityGroupSelector: 
        {{- with .Values.singleuser.karpenter.provider.securityGroupSelector }}
        {{- . | toYaml | nindent 8 }}
        {{- end }}
    tags:
        provisioned: karpenter
{{- end }}
